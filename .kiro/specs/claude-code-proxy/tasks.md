# 实现计划：Claude Code Proxy 集成

## 概述

本实现计划将 Claude Code Proxy 功能集成到 Claude Code UI 中。该功能允许用户通过 Claude CLI 和代理服务器访问 Claude API。实现将参考 Cursor CLI 的集成方式，使用子进程管理和流式输出解析。

## 任务

- [x] 1. 创建 Claude Code Proxy 核心模块
  - 创建 `server/claude-code-proxy.js` 文件
  - 实现进程管理和消息解析逻辑
  - _需求: 2.1, 2.2, 2.3, 2.4, 2.5, 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 1.1 实现环境变量检测函数
  - 创建 `checkProxyConfiguration()` 函数
  - 检测 `ANTHROPIC_BASE_URL` 和 `ANTHROPIC_API_KEY`
  - 返回配置状态对象
  - _需求: 1.1, 1.2, 1.3, 1.4_

- [x] 1.2 实现 Claude CLI 安装检测
  - 创建 `checkClaudeCLI()` 函数
  - 执行 `claude --version` 检查安装
  - 处理命令不存在的情况
  - _需求: 6.1_

- [x] 1.3 实现命令参数构建函数
  - 创建 `buildClaudeArgs()` 函数
  - 支持 `--resume`, `-p`, `--model` 等参数
  - 支持 `--output-format stream-json`
  - 支持 `--dangerously-skip-permissions` 选项
  - _需求: 8.1, 8.2, 8.3, 8.4, 8.5_

- [x] 1.4 实现主进程启动函数
  - 创建 `spawnClaudeProxy()` 函数
  - 使用 `spawn()` 启动 Claude CLI 进程
  - 传递环境变量到子进程
  - 设置工作目录为项目路径
  - _需求: 2.1, 2.2, 2.3_

- [x] 1.5 实现输出流解析
  - 监听 `stdout` 事件
  - 按行分割输出
  - 解析 JSON 格式的输出
  - 处理非 JSON 输出
  - _需求: 2.4, 2.5, 9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 1.6 实现消息格式转换
  - 将 `type: system` 转换为 `session-created`
  - 将 `type: user` 转换为 `cursor-user`
  - 将 `type: assistant` 转换为 `claude-response`
  - 将 `type: result` 转换为 `claude-complete`
  - _需求: 5.1, 5.2, 5.3, 5.4, 5.5, 10.1, 10.2_

- [x] 1.7 实现会话 ID 捕获
  - 从 `system.init` 消息中提取 `session_id`
  - 更新进程映射的键
  - 调用 `ws.setSessionId()` 设置会话 ID
  - 发送 `session-created` 事件
  - _需求: 4.1_

- [x] 1.8 实现错误处理
  - 监听 `stderr` 事件
  - 监听 `error` 事件
  - 监听 `close` 事件
  - 发送错误消息到客户端
  - 清理进程引用
  - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 1.9 实现进程管理函数
  - 创建 `activeClaudeProxyProcesses` Map
  - 实现 `abortClaudeProxySession()` 函数
  - 实现 `isClaudeProxySessionActive()` 函数
  - 实现 `getActiveClaudeProxySessions()` 函数
  - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 2. 集成到 WebSocket 处理器
  - 修改 `server/index.js` 的 `handleChatConnection` 函数
  - 添加 `claude-proxy-command` 消息类型处理
  - 添加 `abort-session` 的 `claude-proxy` 提供商处理
  - _需求: 10.1, 10.2_

- [x] 2.1 添加 claude-proxy-command 处理
  - 在 `handleChatConnection` 中添加新的 `else if` 分支
  - 调用 `spawnClaudeProxy()` 函数
  - 传递命令、选项和 WebSocket writer
  - _需求: 2.1, 2.2, 2.3_

- [x] 2.2 添加 abort-session 处理
  - 检查 `provider === 'claude-proxy'`
  - 调用 `abortClaudeProxySession()`
  - 发送 `session-aborted` 响应
  - _需求: 3.3_

- [x] 3. 创建状态检测 API
  - 创建新的路由文件 `server/routes/claude-proxy.js`
  - 实现 `GET /api/claude-proxy/status` 端点
  - 返回环境变量和 CLI 安装状态
  - _需求: 1.5, 14.1, 14.2, 14.3_

- [x] 3.1 实现状态检测端点
  - 调用 `checkProxyConfiguration()`
  - 调用 `checkClaudeCLI()`
  - 组合返回状态对象
  - 处理错误情况
  - _需求: 1.3, 1.4, 1.5_

- [x] 3.2 注册路由到 Express
  - 在 `server/index.js` 中导入路由
  - 使用 `app.use('/api/claude-proxy', ...)` 注册
  - 添加身份验证中间件
  - _需求: 14.1_

- [x] 4. 更新前端提供商选择器
  - 修改提供商选择组件
  - 添加 Claude Code Proxy 选项
  - 实现状态检测逻辑
  - _需求: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 4.1 添加状态检测 Hook
  - 创建 `useClaudeProxyStatus` Hook
  - 调用 `/api/claude-proxy/status` API
  - 返回可用性状态
  - _需求: 1.5, 7.2_

- [x] 4.2 更新提供商列表
  - 在提供商数组中添加 `claude-proxy` 选项
  - 根据状态显示/隐藏选项
  - 添加提供商描述和图标
  - _需求: 7.1, 7.2_

- [x] 4.3 实现提供商切换逻辑
  - 保存选择到 localStorage
  - 更新 UI 显示当前提供商
  - 保持项目和会话状态
  - _需求: 7.3, 7.4, 7.5_

- [x] 5. 更新 ChatInterface 组件
  - 修改消息发送逻辑
  - 根据提供商发送不同的消息类型
  - _需求: 10.1, 10.2, 10.3, 10.4, 10.5_

- [x] 5.1 添加提供商判断逻辑
  - 读取当前选择的提供商
  - 根据提供商构建不同的消息对象
  - 发送 `claude-proxy-command` 消息
  - _需求: 7.3, 10.1_

- [x] 5.2 处理会话恢复
  - 传递 `sessionId` 到选项
  - 支持恢复现有会话
  - 支持继续对话
  - _需求: 4.2, 4.3, 4.4, 4.5_

- [ ] 6. 添加配置界面
  - 在设置页面添加 Claude Code Proxy 配置部分
  - 显示环境变量状态
  - 显示连接状态
  - 提供配置帮助
  - _需求: 14.1, 14.2, 14.3, 14.4, 14.5_

- [ ] 6.1 创建配置面板组件
  - 显示 `ANTHROPIC_BASE_URL` 状态
  - 显示 `ANTHROPIC_API_KEY` 状态（隐藏值）
  - 显示 Claude CLI 安装状态
  - 显示代理服务器连接状态
  - _需求: 14.1, 14.2, 14.3_

- [ ] 6.2 添加测试连接功能
  - 创建测试连接按钮
  - 调用测试 API 端点
  - 显示测试结果
  - _需求: 14.4_

- [ ] 6.3 添加配置帮助文档
  - 显示环境变量配置说明
  - 显示 Claude CLI 安装链接
  - 显示故障排除指南
  - _需求: 14.5_

- [ ] 7. 实现安全措施
  - 添加命令注入防护
  - 添加 API 密钥保护
  - 添加路径验证
  - _需求: 13.1, 13.2, 13.3, 13.4, 13.5_

- [ ] 7.1 验证命令参数
  - 使用参数数组而非字符串拼接
  - 验证所有用户输入
  - 防止命令注入
  - _需求: 13.4_

- [ ] 7.2 保护敏感信息
  - 在日志中隐藏 API 密钥
  - 只显示密钥是否存在
  - 不记录完整的环境变量值
  - _需求: 13.1_

- [ ] 7.3 验证项目路径
  - 规范化路径
  - 检查路径在允许范围内
  - 防止路径遍历攻击
  - _需求: 13.2_

- [ ] 8. 添加日志和监控
  - 添加进程启动日志
  - 添加进程终止日志
  - 添加错误日志
  - 添加调试模式支持
  - _需求: 12.1, 12.2, 12.3, 12.4, 12.5_

- [ ] 8.1 实现日志记录
  - 记录所有 Claude CLI 命令调用
  - 记录环境变量配置状态
  - 记录进程生命周期事件
  - 记录所有错误和异常
  - _需求: 12.1, 12.2, 12.3, 12.4_

- [ ] 8.2 添加调试模式
  - 检查 `DEBUG` 环境变量
  - 输出详细的调试信息
  - 记录原始输出内容
  - _需求: 12.5_

- [ ] 9. 编写单元测试
  - 测试环境变量检测
  - 测试命令参数构建
  - 测试输出解析
  - 测试消息转换
  - 测试进程管理
  - _需求: 所有需求_

- [ ]* 9.1 测试环境变量检测
  - 测试两个变量都存在的情况
  - 测试缺少 BASE_URL 的情况
  - 测试缺少 API_KEY 的情况
  - 测试两个变量都缺失的情况
  - _需求: 1.1, 1.2, 1.3, 1.4_

- [ ]* 9.2 测试命令参数构建
  - 测试新会话参数
  - 测试恢复会话参数
  - 测试模型选择参数
  - 测试权限跳过参数
  - _需求: 8.1, 8.2, 8.3, 8.4, 8.5_

- [ ]* 9.3 测试输出解析
  - 测试 JSON 格式解析
  - 测试非 JSON 输出处理
  - 测试多行输出
  - 测试 ANSI 代码处理
  - _需求: 9.1, 9.2, 9.3, 9.4, 9.5_

- [ ]* 9.4 测试消息转换
  - 测试 system 消息转换
  - 测试 user 消息转换
  - 测试 assistant 消息转换
  - 测试 result 消息转换
  - _需求: 10.1, 10.2_

- [ ]* 9.5 测试进程管理
  - 测试进程启动
  - 测试进程终止
  - 测试进程中止
  - 测试进程清理
  - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_

- [ ] 10. 编写集成测试
  - 测试完整的对话流程
  - 测试会话恢复
  - 测试错误处理
  - 测试进程清理
  - _需求: 所有需求_

- [ ]* 10.1 测试新会话创建
  - 启动 Claude CLI 进程
  - 发送用户消息
  - 接收助手响应
  - 验证会话 ID 生成
  - _需求: 4.1, 5.1, 5.2_

- [ ]* 10.2 测试会话恢复
  - 使用现有会话 ID
  - 恢复会话
  - 继续对话
  - 验证历史消息加载
  - _需求: 4.2, 4.3, 4.4, 4.5_

- [ ]* 10.3 测试错误处理
  - 测试 CLI 不存在
  - 测试代理不可达
  - 测试进程崩溃
  - 验证错误消息发送
  - _需求: 6.1, 6.2, 6.3, 6.4_

- [ ]* 10.4 测试进程清理
  - 测试正常终止清理
  - 测试中止清理
  - 测试超时清理
  - 验证资源释放
  - _需求: 3.2, 3.3, 3.5_

- [ ] 11. 编写端到端测试
  - 测试完整的用户工作流
  - 测试提供商切换
  - 测试 UI 交互
  - _需求: 所有需求_

- [ ]* 11.1 测试提供商选择
  - 打开设置页面
  - 选择 Claude Code Proxy
  - 验证选项可用性
  - 验证选择保存
  - _需求: 7.1, 7.2, 7.3_

- [ ]* 11.2 测试对话流程
  - 创建新会话
  - 发送消息
  - 接收响应
  - 验证消息显示
  - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ]* 11.3 测试会话管理
  - 创建多个会话
  - 切换会话
  - 恢复会话
  - 删除会话
  - _需求: 4.1, 4.2, 4.3_

- [ ] 12. 更新文档
  - 更新 README.md
  - 添加配置说明
  - 添加故障排除指南
  - 更新 API 文档
  - _需求: 14.5_

- [ ] 12.1 更新 README
  - 添加 Claude Code Proxy 功能说明
  - 添加环境变量配置示例
  - 添加使用说明
  - _需求: 14.5_

- [ ] 12.2 创建配置指南
  - 说明环境变量设置
  - 说明 Claude CLI 安装
  - 说明代理服务器配置
  - _需求: 1.5, 14.5_

- [ ] 12.3 创建故障排除指南
  - 列出常见问题
  - 提供解决方案
  - 添加调试技巧
  - _需求: 6.5, 14.5_

- [ ] 13. 性能优化
  - 实现进程复用
  - 优化流式处理
  - 添加并发控制
  - _需求: 11.1, 11.2, 11.3, 11.4, 11.5_

- [ ] 13.1 实现进程复用
  - 考虑复用 Claude CLI 进程
  - 使用 `--continue` 参数
  - 实现进程池管理
  - _需求: 11.2_

- [ ] 13.2 优化流式处理
  - 使用异步 I/O
  - 避免缓冲延迟
  - 实时发送输出
  - _需求: 11.1_

- [ ] 13.3 添加并发控制
  - 限制并发进程数量
  - 实现队列机制
  - 优先级调度
  - _需求: 11.4_

- [ ] 14. 最终测试和验证
  - 运行所有测试
  - 验证所有需求
  - 修复发现的问题
  - _需求: 所有需求_

- [ ] 14.1 运行测试套件
  - 运行单元测试
  - 运行集成测试
  - 运行端到端测试
  - 验证测试覆盖率
  - _需求: 所有需求_

- [ ] 14.2 手动测试
  - 测试所有用户场景
  - 测试错误情况
  - 测试边界条件
  - _需求: 所有需求_

- [ ] 14.3 性能测试
  - 测试响应时间
  - 测试并发处理
  - 测试资源使用
  - _需求: 11.1, 11.2, 11.3, 11.4, 11.5_

- [ ] 14.4 安全审计
  - 检查命令注入防护
  - 检查敏感信息保护
  - 检查权限控制
  - _需求: 13.1, 13.2, 13.3, 13.4, 13.5_

## 注意事项

- 任务标记 `*` 的为可选测试任务，可以根据时间和资源决定是否实施
- 每个任务都引用了相关的需求编号，便于追溯
- 建议按顺序执行任务，确保依赖关系正确
- 在实现过程中，参考 `server/cursor-cli.js` 的实现方式
- 确保与现有 Claude SDK 提供商完全隔离，避免相互影响
- 所有代码应遵循项目的编码规范和最佳实践
